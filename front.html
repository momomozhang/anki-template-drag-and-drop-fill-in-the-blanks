<div class="drag-drop-container">
    <!-- Question with inline drop zones -->
    <div class="study-question" id="study-question">
        <!-- Will be populated by parseQuestion() -->
    </div>
    
    <!-- Draggable Items -->
    <div class="draggable-items-container">
        <h4>Drag these items to fill the blanks:</h4>
        <div class="draggable-items" id="draggable-items">
            <!-- Will be populated by createDraggableItems() -->
        </div>
    </div>
    
    <!-- Controls -->
    <div class="study-controls">
        <button class="study-btn" id="show-answers-btn">Show Answers</button>
        <button class="study-btn" id="reset-btn">Reset</button>
    </div>
    
</div>

{{#Question}}
<!-- Store field content in hidden div -->
<div id="question-data" style="display: none;">{{Question}}</div>

<script>
(function() {
    // Global state for drag-and-drop functionality
    var studyState = {
        correctAnswers: new Map(),
        userAnswers: new Map()
    };

// Initialize study mode
function initializeStudyMode() {
    parseQuestion();
    createDraggableItems();
    resetStudyState();
    attachDragAndDropEvents();
    attachControlEvents();
}

// Parse question field and create inline drop zones
function parseQuestion() {
    // Get field content from hidden div instead of field substitution
    var questionField = document.getElementById('question-data').textContent;
    var studyQuestion = document.getElementById('study-question');
    
    // Reset study state
    studyState.correctAnswers.clear();
    
    // Check if we have valid Question field content
    if (!questionField || questionField.trim() === '' || questionField === '{{Question}}') {
        studyQuestion.innerHTML = '<p style="color: #666; font-style: italic;">No question content found. Please add content to your Question field.</p>';
        return;
    }
    
    // Replace [[dN::text]] syntax with inline drop zones
    var studyContent = questionField.replace(/\[\[d(\d+)::([^\]]+)\]\]/g, function(match, num, text) {
        var blankId = 'd' + num;
        
        // Store correct answer
        studyState.correctAnswers.set(blankId, text);
        
        // Return inline drop zone
        return '<span class="inline-drop-zone" data-blank-id="' + blankId + '"></span>';
    });
    
    // If no drag-drop syntax found, show informational message
    if (studyContent === questionField) {
        studyContent = questionField + '<br><br><em style="color: #666;">No drag-drop blanks found. Use the add-on to create [[d1::text]] syntax.</em>';
    }
    
    studyQuestion.innerHTML = studyContent;
}

// Create draggable items from Question field syntax
function createDraggableItems() {
    // Get field content from hidden div
    var questionField = document.getElementById('question-data').textContent;
    var draggableItems = document.getElementById('draggable-items');
    
    // Extract items from [[dN::text]] syntax
    var items = [];
    var regex = /\[\[d\d+::([^\]]+)\]\]/g;
    var match;
    while ((match = regex.exec(questionField)) !== null) {
        items.push(match[1].trim());
    }
    
    // If no items found, show helpful message
    if (items.length === 0) {
        draggableItems.innerHTML = '<p style="color: #666; font-style: italic;">No draggable items found. Use the add-on to create [[d1::text]] syntax.</p>';
        return;
    }
    
    // Shuffle items
    items = shuffleArray(items);
    
    // Create draggable elements
    draggableItems.innerHTML = '';
    items.forEach(function(item, index) {
        var itemElement = document.createElement('div');
        itemElement.className = 'draggable-item';
        itemElement.draggable = true;
        itemElement.textContent = item;
        itemElement.setAttribute('data-item-text', item);
        itemElement.setAttribute('data-item-index', index);
        draggableItems.appendChild(itemElement);
    });
}

// Shuffle array utility
function shuffleArray(array) {
    var shuffled = array.slice();
    for (var i = shuffled.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = shuffled[i];
        shuffled[i] = shuffled[j];
        shuffled[j] = temp;
    }
    return shuffled;
}

// Reset study state
function resetStudyState() {
    studyState.userAnswers.clear();
}

// Attach drag and drop events
function attachDragAndDropEvents() {
    var draggableItems = document.getElementById('draggable-items');
    var studyQuestion = document.getElementById('study-question');
    
    // Draggable items events
    var items = draggableItems.querySelectorAll('.draggable-item');
    for (var i = 0; i < items.length; i++) {
        items[i].addEventListener('dragstart', handleDragStart);
        items[i].addEventListener('dragend', handleDragEnd);
    }
    
    // Drop zones events
    var dropZones = studyQuestion.querySelectorAll('.inline-drop-zone');
    for (var i = 0; i < dropZones.length; i++) {
        dropZones[i].addEventListener('dragover', handleDragOver);
        dropZones[i].addEventListener('dragenter', handleDragEnter);
        dropZones[i].addEventListener('dragleave', handleDragLeave);
        dropZones[i].addEventListener('drop', handleDrop);
        dropZones[i].addEventListener('click', handleDropZoneClick);
    }
}

// Attach control events
function attachControlEvents() {
    var showAnswersBtn = document.getElementById('show-answers-btn');
    var resetBtn = document.getElementById('reset-btn');
    
    showAnswersBtn.addEventListener('click', showAnswers);
    resetBtn.addEventListener('click', resetStudy);
}

// Drag and drop event handlers
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.getAttribute('data-item-text'));
    e.dataTransfer.setData('item-index', e.target.getAttribute('data-item-index'));
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDragEnter(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    
    var itemText = e.dataTransfer.getData('text/plain');
    var itemIndex = e.dataTransfer.getData('item-index');
    var blankId = e.target.getAttribute('data-blank-id');
    
    // Fill the drop zone
    e.target.textContent = itemText;
    e.target.classList.add('filled');
    
    // Mark item as used
    var draggableItems = document.getElementById('draggable-items');
    var draggedItem = draggableItems.querySelector('[data-item-index="' + itemIndex + '"]');
    if (draggedItem) {
        draggedItem.classList.add('used');
    }
    
    // Store user answer
    studyState.userAnswers.set(blankId, itemText);
    
    // Remove previous answer if any
    var previousItem = draggableItems.querySelector('[data-item-text="' + itemText + '"]');
    if (previousItem && previousItem !== draggedItem) {
        previousItem.classList.remove('used');
    }
}

function handleDropZoneClick(e) {
    if (e.target.classList.contains('filled')) {
        // Remove item from drop zone
        var blankId = e.target.getAttribute('data-blank-id');
        var itemText = e.target.textContent;
        
        // Clear drop zone
        e.target.textContent = '';
        e.target.classList.remove('filled', 'correct', 'incorrect');
        
        // Unmark item as used
        var draggableItems = document.getElementById('draggable-items');
        var item = draggableItems.querySelector('[data-item-text="' + itemText + '"]');
        if (item) {
            item.classList.remove('used');
        }
        
        // Remove from user answers
        studyState.userAnswers.delete(blankId);
    }
}


// Show answers
function showAnswers() {
    var studyQuestion = document.getElementById('study-question');
    var draggableItems = document.getElementById('draggable-items');
    
    // Process each blank with appropriate color coding
    studyState.correctAnswers.forEach(function(correctAnswer, blankId) {
        var dropZone = studyQuestion.querySelector('[data-blank-id="' + blankId + '"]');
        var userAnswer = studyState.userAnswers.get(blankId);
        
        // Set the correct text
        dropZone.textContent = correctAnswer;
        
        // Apply appropriate styling based on user's original answer
        dropZone.classList.remove('filled', 'correct', 'incorrect', 'auto-filled');
        
        if (!userAnswer) {
            // Empty blank - show in grey
            dropZone.classList.add('auto-filled');
        } else if (userAnswer === correctAnswer) {
            // User was correct - show in green
            dropZone.classList.add('correct');
        } else {
            // User was incorrect - show in pink/red
            dropZone.classList.add('incorrect');
        }
    });
    
    // Mark all items as used
    var items = draggableItems.querySelectorAll('.draggable-item');
    for (var i = 0; i < items.length; i++) {
        items[i].classList.add('used');
    }
}


// Reset study
function resetStudy() {
    // Re-initialize entire study mode to restore original state
    initializeStudyMode();
    
    // Ensure draggable container is visible
    var draggableItemsContainer = document.getElementById('draggable-items-container');
    if (draggableItemsContainer) {
        draggableItemsContainer.style.display = 'block';
    }
}

// Initialize immediately - no event waiting
initializeStudyMode();

})();
</script>
{{/Question}}